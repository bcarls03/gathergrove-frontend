// src/pages/OnboardingAccess.tsx
/**
 * V15 Step 1: OAuth Authentication
 * 
 * Users sign in with Google, Apple, Facebook, or Microsoft.
 * This is the entry point for the V15 onboarding flow.
 */
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { motion } from "framer-motion";
import { OnboardingLayout } from "../components/OnboardingLayout";
import {
  signInWithGoogle,
  signInWithApple,
  signInWithFacebook,
  signInWithMicrosoft,
} from "../lib/firebase";
import { signupUser, type UserSignupRequest } from "../lib/api";
import { setOnboardingState } from "../lib/onboarding";

export default function OnboardingAccess() {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleOAuthSignIn = async (
    provider: "google" | "apple" | "facebook" | "microsoft"
  ) => {
    setLoading(true);
    setError(null);

    try {
      let result;
      
      switch (provider) {
        case "google":
          result = await signInWithGoogle();
          break;
        case "apple":
          result = await signInWithApple();
          break;
        case "facebook":
          result = await signInWithFacebook();
          break;
        case "microsoft":
          result = await signInWithMicrosoft();
          break;
      }

      const user = result.user;
      console.log("âœ… OAuth successful:", provider, user.uid);

      // Extract user info from OAuth provider
      const displayName = user.displayName || "";
      const nameParts = displayName.split(" ");
      const firstName = nameParts[0] || "";
      const lastName = nameParts.slice(1).join(" ") || "";

      // Create user profile in backend
      const payload: UserSignupRequest = {
        uid: user.uid,
        email: user.email || "",
        first_name: firstName,
        last_name: lastName,
        profile_photo_url: user.photoURL || null,
        visibility: "neighbors",
      };

      try {
        await signupUser(payload);
        console.log("âœ… User profile created");
      } catch (err: any) {
        // If user already exists (409), that's okay - they're logging back in
        if (err?.response?.status === 409) {
          console.log("â„¹ï¸ User already exists, continuing...");
        } else {
          throw err;
        }
      }

      // Save to onboarding state
      setOnboardingState({
        firstName,
        lastName,
        email: user.email || "",
        profilePhotoUrl: user.photoURL || null,
      });

      // Navigate to Step 2: Location
      navigate("/onboarding/address");
    } catch (err: any) {
      console.error("âŒ OAuth error:", err);
      setError(err?.message || "Authentication failed. Please try again.");
      setLoading(false);
    }
  };
  const canContinue = normalized.length > 0;

  function handleChange(e: React.ChangeEvent<HTMLInputElement>) {
    // keep hyphens; strip spaces; uppercase
    const value = normalizeNeighborhoodCode(e.target.value);
    setNeighborhoodCode(value);
    setValidated(false);
    setHasValidatedSuccess(false);
  }

  function handleBlur() {
    setTouched(true);
  }

  function handleContinue(e: React.FormEvent) {
    e.preventDefault();
    setTouched(true);
    setValidated(true);

    const code = normalizeNeighborhoodCode(neighborhoodCode);

    // Empty â†’ show required error
    if (code.length === 0) {
      setHasValidatedSuccess(false);
      return;
    }

    // Invalid â†’ show error
    if (!NEIGHBORHOOD_CODES[code]) {
      setHasValidatedSuccess(false);
      return;
    }

    // Valid â†’ save ONLY what OnboardingState supports
    const prev = getOnboardingState();
    setOnboardingState({
      ...prev,
      neighborhoodCode: code,
    });

    // First successful submit: show "Welcome" state and wait for a second click
    if (!hasValidatedSuccess) {
      setHasValidatedSuccess(true);
      return;
    }

    // Second successful submit: move on
    navigate("/onboarding/household");
  }

  const showRequiredError = validated && normalized.length === 0;
  const showCodeError = validated && normalized.length > 0 && !isValidCode;

  // Show the success box only after validate
  const displayLabel = neighborhoodLabelFromCode(normalized) || "";
  const showSuccess = validated && isValidCode && !!displayLabel;

  return (
    <OnboardingLayout currentStep="access">
      <form onSubmit={handleContinue}>
        <div style={cardStyle}>
          <h1
            style={{
              fontSize: 22,
              fontWeight: 700,
              marginTop: 4,
              marginBottom: 8,
              color: "#111827",
            }}
          >
            Welcome to GatherGrove
          </h1>

          <p style={{ fontSize: 13, color: "#4b5563", marginBottom: 18 }}>
            Enter your neighborhood code to join your community.
          </p>

          <label style={labelStyle} htmlFor="neighborhoodCode">
            Neighborhood code
          </label>

          <input
            id="neighborhoodCode"
            type="text"
            autoComplete="off"
            placeholder={NEIGHBORHOOD_PLACEHOLDER}
            value={neighborhoodCode}
            onChange={handleChange}
            onBlur={handleBlur}
            style={{
              ...inputStyle,
              borderColor:
                touched && (showRequiredError || showCodeError) ? "#f97373" : "#d1d5db",
            }}
          />

          {showRequiredError && (
            <div style={{ ...helperStyle, color: "#b91c1c", marginTop: 6 }}>
              Please enter your neighborhood code to continue.
            </div>
          )}

          {showCodeError && (
            <div style={{ ...helperStyle, color: "#b91c1c", marginTop: 6 }}>
              That code doesnâ€™t match any neighborhood. Double-check the code or reach out to
              the person who shared it with you.
            </div>
          )}

          {showSuccess && (
            <div style={successBoxStyle}>
              <span aria-hidden="true">ðŸŒ¿</span>
              <div>
                <div style={successTitleStyle}>Welcome to {displayLabel}!</div>
                <div>
                  Youâ€™re joining the <strong>{displayLabel}</strong> neighborhood community.
                </div>
              </div>
            </div>
          )}

          <p style={helperStyle}>
            <span aria-hidden="true">ðŸ”’</span>
            <span>
              Private and secure. Only households in your neighborhood can join with this
              code. No addresses or child names are ever shown.
            </span>
          </p>

          <button
            type="submit"
            style={{
              ...buttonStyle,
              background: canContinue ? "#059669" : "#d1d5db",
              color: canContinue ? "#ffffff" : "#6b7280",
              cursor: canContinue ? "pointer" : "default",
            }}
            disabled={!canContinue}
          >
            Continue
          </button>
        </div>
      </form>
    </OnboardingLayout>
  );
}
